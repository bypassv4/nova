<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Proxy Loader</title>
<style>
  html, body {margin:0;padding:0;width:100%;height:100%;background:white}
  #proxyFrame {position:fixed;top:0;left:0;width:100%;height:100%;border:none}
  #status {
    position:fixed;left:12px;bottom:12px;
    background:rgba(0,0,0,.7);color:#fff;
    padding:6px 10px;border-radius:8px;font:13px system-ui;
  }
</style>
</head>
<body>
  <iframe id="proxyFrame" sandbox="allow-scripts allow-forms"></iframe>
  <div id="status">Loading…</div>
<script>
const TRY_TIMEOUT_MS = 5000;

function censor(url){
  if(!url) return "";
  const clean = url.replace(/https?:\/\//,'');
  if(clean.length<=4) return clean;
  return clean.slice(0,2) + "*".repeat(clean.length-4) + clean.slice(-2);
}

async function getProxyList(){
  const r = await fetch("./links.json");
  if(!r.ok) throw new Error("links.json missing");
  return r.json();
}

function getMainDomain(url){
  try{
    const u = new URL(url);
    const parts = u.hostname.split('.');
    // Get last 2 parts (e.g., yourmom.com from skibidi.yourmom.com)
    if(parts.length>=2){
      return parts.slice(-2).join('.');
    }
    return u.hostname;
  }catch(e){
    return "";
  }
}

async function tryProxy(url){
  return new Promise((resolve,reject)=>{
    const frame = document.getElementById("proxyFrame");
    let done=false;
    let loadCount=0;
    function end(ok,err){
      if(done) return; done=true;
      clearTimeout(timer);
      frame.removeEventListener("load",onload);
      frame.removeEventListener("error",onerror);
      ok?resolve(url):reject(err||new Error("failed"));
    }
    function onerror(){
      end(false,new Error("Load error"));
    }
    function onload(){
      loadCount++;
      // If the iframe loads multiple times, it likely got redirected
      if(loadCount>1){
        end(false,new Error("Blocked - multiple redirects detected"));
        return;
      }
      // Try to detect domain change via contentWindow access
      setTimeout(()=>{
        try{
          // Attempt to access contentWindow.location - will throw if cross-origin
          const loc = frame.contentWindow.location.hostname;
          const originalDomain = getMainDomain(url);
          const currentDomain = getMainDomain("https://"+loc);
          
          if(currentDomain && originalDomain && currentDomain !== originalDomain){
            end(false,new Error("Blocked - redirected to "+currentDomain));
            return;
          }
        }catch(e){
          // Cross-origin error means we can't check - check if it's the expected domain
          // If we get SecurityError, the iframe is on a different origin
          try{
            // This will fail silently if cross-origin
            frame.contentWindow.document;
            // If we got here, same origin - good!
            end(true);
          }catch(e2){
            // Cross-origin - could be blocked. Let's fail it.
            end(false,new Error("Blocked - cross-origin redirect detected"));
          }
          return;
        }
        end(true);
      },1500);
    }
    frame.addEventListener("load",onload);
    frame.addEventListener("error",onerror);
    frame.sandbox="allow-scripts allow-forms allow-same-origin";
    try{ frame.src=url; }catch(e){ end(false,e); return;}
    const timer=setTimeout(()=>end(false,new Error("timeout")),TRY_TIMEOUT_MS);
  });
}

(async()=>{
  const s=document.getElementById("status");
  const proxies=await getProxyList();
  for(const url of proxies){
    s.textContent="Trying "+censor(url);
    try{
      await tryProxy(url);
      s.textContent="Connected: "+censor(url);
      return;
    }catch(e){
      console.warn("Fail",url,e);
      s.textContent="Blocked "+censor(url)+" → next…";
      await new Promise(r=>setTimeout(r,1000));
    }
  }
  s.textContent="All proxies failed.";
})();
</script>
</body>
</html>
